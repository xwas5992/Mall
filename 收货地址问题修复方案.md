# 收货地址问题修复方案

## 问题分析

### 1. 400错误原因
- **拦截器误拦截**：ParameterValidationInterceptor拦截了地址API的userId参数
- **缺少认证头**：前端调用地址API时没有添加Authorization头
- **CORS配置**：后端缺少CORS配置

### 2. 显示问题原因
- **删除按钮文字错误**：显示"打撒打"应该是"删除"
- **缺少错误处理**：API调用失败时没有用户友好的提示

## 修复内容

### 1. 后端修复

#### 1.1 修改拦截器配置
**文件**: `user-service/src/main/java/com/mall/userservice/interceptor/ParameterValidationInterceptor.java`
- 添加地址API排除规则，避免误拦截userId参数

#### 1.2 添加CORS配置
**文件**: `user-service/src/main/java/com/mall/userservice/config/WebConfig.java`
- 添加CORS映射配置，支持跨域请求

### 2. 前端修复

#### 2.1 添加认证头
**文件**: `frontend/portal/portal.js`
- 所有地址API调用都添加Authorization头
- 添加详细的错误处理和日志

#### 2.2 修复UI问题
- 修复删除按钮文字（"打撒打" → "删除"）
- 添加操作成功/失败的Toast提示

#### 2.3 改进错误处理
- 添加try-catch错误处理
- 添加用户友好的错误提示
- 添加详细的调试日志

## 测试步骤

### 1. 启动服务
```bash
# 启动User Service
cd user-service
mvn spring-boot:run

# 启动Nginx
start-nginx-mall.bat
```

### 2. 运行诊断脚本
```bash
debug-address-issue.bat
```

### 3. 前端测试
1. 打开 `http://localhost/portal/portal.html`
2. 登录用户账号
3. 点击"收货地址"菜单
4. 测试添加、删除、设置默认地址功能

## 预期效果

### 修复前
- ❌ 点击收货地址报400错误
- ❌ 删除按钮显示"打撒打"
- ❌ 操作失败时无提示

### 修复后
- ✅ 正常显示收货地址列表
- ✅ 可以添加新地址
- ✅ 可以删除地址（按钮显示"删除"）
- ✅ 可以设置默认地址
- ✅ 操作成功/失败都有Toast提示
- ✅ 详细的错误日志便于调试

## 注意事项

1. **确保User Service在8085端口运行**
2. **确保MySQL服务正常运行**
3. **确保mall_user数据库存在**
4. **确保用户已登录且有有效token**

## 故障排除

如果仍有问题，请检查：
1. 浏览器控制台是否有错误信息
2. User Service日志是否有异常
3. 数据库连接是否正常
4. Nginx代理配置是否正确 